# AI工程化深度解析

## 目录
- [一、MLOps](#一mlops)
- [二、模型服务化](#二模型服务化)
- [三、A/B测试](#三ab测试)
- [四、特征工程](#四特征工程)

## 一、MLOps

### 1.1 ML Pipeline

```python
from airflow import DAG
from airflow.operators.python import PythonOperator

dag = DAG('ml_pipeline', schedule_interval='@daily')

def extract_data():
    # 数据提取
    pass

def train_model():
    # 模型训练
    pass

def evaluate_model():
    # 模型评估
    pass

def deploy_model():
    # 模型部署
    pass

t1 = PythonOperator(task_id='extract', python_callable=extract_data, dag=dag)
t2 = PythonOperator(task_id='train', python_callable=train_model, dag=dag)
t3 = PythonOperator(task_id='evaluate', python_callable=evaluate_model, dag=dag)
t4 = PythonOperator(task_id='deploy', python_callable=deploy_model, dag=dag)

t1 >> t2 >> t3 >> t4
```

### 1.2 实验跟踪

```python
import mlflow

with mlflow.start_run():
    # 训练模型
    model = train_model(params)
    
    # 记录参数
    mlflow.log_params(params)
    
    # 记录指标
    mlflow.log_metrics({
        'accuracy': accuracy,
        'loss': loss
    })
    
    # 保存模型
    mlflow.sklearn.log_model(model, "model")
```

## 二、模型服务化

### 2.1 TensorFlow Serving

```bash
# 导出模型
python
import tensorflow as tf

model.save('/models/my_model/1')

# 启动服务
docker run -p 8501:8501 \
  --mount type=bind,source=/models/my_model,target=/models/my_model \
  -e MODEL_NAME=my_model \
  -t tensorflow/serving
```

**调用服务**：
```python
import requests
import json

data = {
    "instances": [[1.0, 2.0, 3.0]]
}

response = requests.post(
    'http://localhost:8501/v1/models/my_model:predict',
    data=json.dumps(data)
)

predictions = response.json()['predictions']
```

### 2.2 ONNX Runtime

```python
import onnxruntime as ort

# 加载模型
session = ort.InferenceSession("model.onnx")

# 推理
inputs = {session.get_inputs()[0].name: input_data}
outputs = session.run(None, inputs)
```

## 三、A/B测试

### 3.1 流量分配

```python
import hashlib

def assign_bucket(user_id, experiment_id):
    hash_key = f"{experiment_id}:{user_id}"
    hash_value = int(hashlib.md5(hash_key.encode()).hexdigest(), 16)
    return hash_value % 100

def get_version(user_id):
    bucket = assign_bucket(user_id, 'exp_001')
    if bucket < 50:
        return 'A'  # 对照组
    else:
        return 'B'  # 实验组
```

### 3.2 指标计算

```python
class ABTestAnalyzer:
    def calculate_metrics(self, group_a, group_b):
        # 转化率
        cvr_a = sum(group_a['converted']) / len(group_a)
        cvr_b = sum(group_b['converted']) / len(group_b)
        
        # 显著性检验
        from scipy.stats import chi2_contingency
        
        obs = [[sum(group_a['converted']), len(group_a) - sum(group_a['converted'])],
               [sum(group_b['converted']), len(group_b) - sum(group_b['converted'])]]
        
        chi2, p_value, dof, expected = chi2_contingency(obs)
        
        return {
            'cvr_a': cvr_a,
            'cvr_b': cvr_b,
            'lift': (cvr_b - cvr_a) / cvr_a,
            'p_value': p_value,
            'significant': p_value < 0.05
        }
```

## 四、特征工程

### 4.1 特征存储

```python
from feast import FeatureStore

# 定义特征
store = FeatureStore(repo_path=".")

# 获取特征
features = store.get_online_features(
    features=[
        'user_features:age',
        'user_features:city',
        'item_features:category'
    ],
    entity_rows=[
        {"user_id": 1001, "item_id": 2001}
    ]
).to_dict()
```

### 4.2 特征转换

```python
from sklearn.preprocessing import StandardScaler, LabelEncoder

class FeatureTransformer:
    def __init__(self):
        self.scalers = {}
        self.encoders = {}
    
    def fit_transform(self, df):
        # 数值特征标准化
        numeric_features = ['age', 'price']
        for col in numeric_features:
            self.scalers[col] = StandardScaler()
            df[col] = self.scalers[col].fit_transform(df[[col]])
        
        # 类别特征编码
        categorical_features = ['gender', 'city']
        for col in categorical_features:
            self.encoders[col] = LabelEncoder()
            df[col] = self.encoders[col].fit_transform(df[col])
        
        return df
```

---

**关键字**：MLOps、模型服务、TensorFlow Serving、A/B测试、特征工程

