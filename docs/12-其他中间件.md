# 其他中间件深度解析

## 目录
- [一、ElasticSearch](#一elasticsearch)
- [二、Zookeeper](#二zookeeper)
- [三、Nacos](#三nacos)
- [四、高频面试题](#四高频面试题)

## 一、ElasticSearch

### 1.1 核心概念

- **Index**：索引（类似数据库）
- **Type**：类型（7.x后废弃）
- **Document**：文档（类似行）
- **Field**：字段（类似列）

### 1.2 基本操作

```java
@Service
public class ESService {
    
    @Autowired
    private ElasticsearchRestTemplate esTemplate;
    
    // 创建索引
    public void createIndex() {
        IndexOperations indexOps = esTemplate.indexOps(Product.class);
        indexOps.create();
    }
    
    // 添加文档
    public void save(Product product) {
        esTemplate.save(product);
    }
    
    // 搜索
    public List<Product> search(String keyword) {
        NativeSearchQuery query = new NativeSearchQueryBuilder()
            .withQuery(QueryBuilders.matchQuery("name", keyword))
            .build();
        
        SearchHits<Product> hits = esTemplate.search(query, Product.class);
        return hits.stream()
            .map(SearchHit::getContent)
            .collect(Collectors.toList());
    }
}
```

### 1.3 倒排索引

```
文档1: "Elasticsearch is great"
文档2: "Elasticsearch and Kibana"

倒排索引:
elasticsearch -> [1, 2]
is -> [1]
great -> [1]
and -> [2]
kibana -> [2]
```

## 二、Zookeeper

### 2.1 核心概念

- **Znode**：节点
- **Watcher**：监听器
- **Session**：会话
- **ACL**：访问控制

### 2.2 节点类型

1. **持久节点**：create /node data
2. **临时节点**：create -e /node data
3. **顺序节点**：create -s /node data
4. **临时顺序节点**：create -e -s /node data

### 2.3 应用场景

**1. 分布式锁**：
```java
@Component
public class ZKLock {
    
    @Autowired
    private CuratorFramework client;
    
    public void lock() throws Exception {
        InterProcessMutex lock = new InterProcessMutex(client, "/locks/myLock");
        try {
            if (lock.acquire(10, TimeUnit.SECONDS)) {
                // 业务逻辑
            }
        } finally {
            lock.release();
        }
    }
}
```

**2. 服务注册发现**：
```java
public void register(String serviceName, String host, int port) throws Exception {
    String path = "/services/" + serviceName + "/" + host + ":" + port;
    client.create()
        .creatingParentsIfNeeded()
        .withMode(CreateMode.EPHEMERAL)
        .forPath(path);
}
```

## 三、Nacos

### 3.1 服务注册

```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: dev
```

```java
@SpringBootApplication
@EnableDiscoveryClient
public class Application {
}
```

### 3.2 配置中心

```yaml
spring:
  cloud:
    nacos:
      config:
        server-addr: localhost:8848
        file-extension: yaml
```

```java
@RefreshScope
@RestController
public class ConfigController {
    
    @Value("${config.value}")
    private String value;
    
    @GetMapping("/config")
    public String getConfig() {
        return value;
    }
}
```

## 四、高频面试题

### Q1：ES为什么快？

1. **倒排索引**：快速定位文档
2. **分片**：并行搜索
3. **文件系统缓存**：热数据在内存

### Q2：ZooKeeper如何保证一致性？

- **ZAB协议**（Zookeeper Atomic Broadcast）
- **Leader选举**
- **过半机制**

### Q3：Nacos和Eureka的区别？

| 特性 | Nacos | Eureka |
|------|-------|--------|
| AP/CP | 支持切换 | AP |
| 配置中心 | 支持 | 不支持 |
| 健康检查 | TCP/HTTP/MySQL | HTTP |

---

**关键字**：ElasticSearch、Zookeeper、Nacos、倒排索引、ZAB协议

